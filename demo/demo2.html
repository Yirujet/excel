<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      body {
        margin: 0;
        padding: 0;
      }

      #app {
        width: 95vw;
        height: calc(100vh - 100px);
        margin-left: 20px;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div id="app"></div>
  </body>
  <script src="./script/html2canvas.js"></script>
  <script src="../lib/excel.umd.js"></script>
  <script src="./mock.js"></script>
  <script>
    const { colWidth, rowHeight, mergeCell, configData } = data;
    const colCount = configData[0].length;
    const rowCount = configData.length;
    const cells = [];
    let cellX = 0;
    let cellY = 0;
    const richCells = [];
    for (let i = 0; i < rowCount; i++) {
      let row = [];
      cellX = 0;
      if (i > 0) {
        cellY += rowHeight[i - 1];
      }
      for (let j = 0; j < colCount; j++) {
        if (j > 0) {
          cellX += colWidth[j - 1];
        }
        const cell = {
          x: j === 0 ? 0 : cellX,
          y: i === 0 ? 0 : cellY,
          width: colWidth[j],
          height: rowHeight[i],
        };
        const cellData = configData[i]?.[j];
        if (cellData && cellData.cellValue !== "") {
          if (
            ["datasets", "static", "function"].includes(cellData.cellTypeDict)
          ) {
            if (cellData.displayType === "plainText") {
              cell.meta = {
                type: "text",
                data: cellData.cellValue,
              };
              cell.value = cellData.cellValue.toString();
              cell.wrap = "wrap";
            }
            if (cellData.displayType === "richText") {
              cell.meta = {
                type: "image",
                data: {
                  img: null,
                  width: 0,
                  height: 0,
                  fit: "fill",
                },
              };
              richCells.push({
                rowIndex: i,
                colIndex: j,
                cellValue: cellData.cellValue,
                cellConfig: cellData.cellConfig,
              });
            }
          }
          if (cellData.cellTypeDict === "oblique_line") {
            cell.meta = {
              type: "diagonal",
              data: {
                value: JSON.parse(cellData.cellValue).biasText.split("|"),
              },
            };
            cell.value = cellData.cellValue.toString();
          }
        }
        if (cellData && cellData.cellConfig && cellData.cellConfig.basicStyle) {
          cell.textStyle = {
            ...cell.textStyle,
            align:
              cellData.cellConfig.basicStyle.alignTypeDict !== "none"
                ? cellData.cellConfig.basicStyle.alignTypeDict
                : "left",
            color: cellData.cellConfig.basicStyle.fontColor || "#000000",
            backgroundColor:
              cellData.cellConfig.basicStyle.colorFill || "#ffffff",
            bold: cellData.cellConfig.basicStyle.fontBold || false,
            fontSize: cellData.cellConfig.basicStyle.fontSize || 12,
            italic: cellData.cellConfig.basicStyle.italic || false,
            fontFamily: cellData.cellConfig.basicStyle.font || "宋体",
          };

          if (
            cellData.cellConfig.basicStyle.border &&
            cellData.cellConfig.basicStyle.border !== "unset"
          ) {
            const [borderWidth, borderStyle, borderColor] =
              cellData.cellConfig.basicStyle.border.split(" ");
            cell.border = {
              top: {
                solid: borderStyle === "solid",
                color: borderColor,
              },
              left: {
                solid: borderStyle === "solid",
                color: borderColor,
              },
              right: {
                solid: borderStyle === "solid",
                color: borderColor,
              },
              bottom: {
                solid: borderStyle === "solid",
                color: borderColor,
              },
            };
          } else {
            cell.border = {
              top: null,
              bottom: null,
              left: null,
              right: null,
            };
          }
        } else {
          cell.border = {
            top: null,
            bottom: null,
            left: null,
            right: null,
          };
        }
        row.push(cell);
      }
      cells.push(row);
    }
    // const mergedCells = mergeCell.map((item) => [
    //   item.row,
    //   item.row - 1 + item.rowspan,
    //   item.col,
    //   item.col - 1 + item.colspan,
    // ]);
    const mergedCells = mergeCell.map((item) => [
      item.row + 1,
      item.row + item.rowspan,
      item.col + 1,
      item.col + item.colspan,
    ]);
    const app = document.querySelector("#app");
    const { width, height, x, y } = app.getBoundingClientRect();
    const excel = new Excel({
      name: "test",
      sheets: [
        {
          name: "sheet1",
          // fixedRowIndex: 0,
          // fixedColIndex: 0,
          fixedRowIndex: 1,
          fixedColIndex: 1,
          rowCount,
          colCount,
          cells,
          mergedCells,
          margin: {
            right: 10,
            bottom: 10,
          },
          // mode: "view",
          mode: "edit",
        },
      ],
    });
    excel.mount(app);
    const richCellsImgs = richCells.map((cell) => {
      return new Promise((resolve) => {
        const richText = cell.cellValue;
        const div = document.createElement("div");
        div.innerHTML = richText;
        div.style.width = colWidth[cell.colIndex] + "px";
        div.style.position = "fixed";
        div.style.pointerEvents = "none";
        div.style.bottom = 9999 + "px";
        if (cell && cell.cellConfig && cell.cellConfig.basicStyle) {
          div.style.textAlign =
            cell.cellConfig.basicStyle.alignTypeDict !== "none"
              ? cell.cellConfig.basicStyle.alignTypeDict
              : "left";
          div.style.color = cell.cellConfig.basicStyle.fontColor || "#000000";
          div.style.backgroundColor =
            cell.cellConfig.basicStyle.colorFill || "#ffffff";
          div.style.fontSize = cell.cellConfig.basicStyle.fontSize || 12;
          div.style.fontFamily = cell.cellConfig.basicStyle.font || "宋体";
          div.style.bold =
            cell.cellConfig.basicStyle.fontBold || false ? "bold" : "normal";
          div.style.italic =
            cell.cellConfig.basicStyle.italic || false ? "italic" : "normal";
        }
        div.id = `richText-${cell.rowIndex}-${cell.colIndex}`;
        document.body.appendChild(div);
        setTimeout(() => {
          const height = div.offsetHeight;
          html2canvas(div).then((canvas) => {
            const img = new Image();
            img.src = canvas.toDataURL();
            img.onload = () => {
              resolve({
                // rowIndex: cell.rowIndex,
                // colIndex: cell.colIndex,
                rowIndex: cell.rowIndex + 1,
                colIndex: cell.colIndex + 1,
                img,
                width: img.width,
                height: img.height,
                fit: "none",
              });
              document.body.removeChild(div);
            };
          });
        });
      });
    });
    Promise.all(richCellsImgs).then((imgs) => {
      imgs.forEach((item) => {
        const { rowIndex, colIndex, img, width, height } = item;
        excel.sheets[0].cells[rowIndex][colIndex].meta = {
          type: "image",
          data: {
            img: img,
            width: item.width,
            height: height,
            fit: "fill",
          },
        };
      });
      excel.sheets[0].adjust();
    });
  </script>
</html>
